{% extends "base.html" %}
{% load static %}

{% block extra_head %}
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
{% endblock %}

{% block load_js %}
    <script src="{% static "assays/grouping_filtering.js" %}"></script>
    <script src="{% static "js/enter_override.js" %}"></script>
    <script src="{% static "assays/assaystudy_upload.js" %}"></script>
    <script src="{% static "assays/chart_display.js" %}"></script>
    <!--sck raw_plate-->
{#    <script type="text/javascript" charset="utf-8" src="{% static "js/tablecellsselection.js" %}"></script>#}

{% endblock %}

{% block breadcrumbs %}
    <li><a href="/assays/assaystudy/editable_studies/">Editable Studies</a></li>
    <li><a href="{{ object.get_absolute_url }}">{{ object }}</a></li>
    <li class="active">Upload Data File</li>
{% endblock %}

{% block sidebar %}
    {% include 'assays/grouping_filtering.html' with charts="true" %}
{% endblock %}

{% block fluid-content %}
    <form enctype="multipart/form-data" class="form-horizontal" method="post" >

    <!--all the functions on this page require the uploaded of a file (either previously or now), show always -->
    <h1>
        Upload Data File for <em>{{ object }}</em>
    <br>
    {% csrf_token %}
{#        <button id="submit" type="submit" class="btn btn-primary">Submit</button>#}
    </h1>

    <legend><br>Select the Type of File to Upload</legend>
    {# sck for raw_plate #}
    <label><input type="radio" name="upload_type" value="mif_c" checked="checked"> MIF-C </label>
    - Upload processed assay data in the required columnar format.
    <br>
    <label><input type="radio" name="upload_type" value="raw_plate"> Raw Plate </label>
    - Upload, process, and/or reprocess a plate reader output file and use the plate reader data processing tool.
    <br>
    <label><input type="radio" name="upload_type" value="supporting_data"> Supporting Data </label>
    - Attach a supporting data file to this study.
    <!--<label><input type="radio" name="upload_type" value="blue"> genomic</label> -->

    {% include "submit.html" %}

    {% include 'errors.html' %}

    {# sck for raw_plate Add/Edit Plate Maps#}
    <div class="raw-plate hidden">
        <legend><br>Plate Map General Information</legend>
        <div class="row">
            <div class="col-sm-12" >
                <b>Select <i>Starting</i> Source: </b>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-12" >
                <label><input type="radio" name="plate_map_type_option" value="matrix"> Use an Existing Matrix </label>
                - MPS model is a plate and the same plate was put directly in the plate reader.
            </div>
        </div>
        <div class="row">
            <div class="col-sm-12" >
                <label><input type="radio" name="plate_map_type_option" value="sample" checked="checked"> Previously Saved Plate Map </label>
                - Previously saved a plate map and want to edit or copy.
            </div>
            <div class="overwrite-plate">
                <div class="row">
                    <div class="col-sm-1">
                    </div>
                    <div class="col-sm-11" >
                        <label><input type="radio" name="plate_map_new_overwrite" value="new_map" checked="checked"> Copy to New Plate Map </label>
                        <br><label><input type="radio" name="plate_map_new_overwrite" value="overwrite_map" > Edit Selected Plate Map (save as) </label>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-12" >
                <label><input type="radio" name="plate_map_type_option" value="empty" > Select Empty Plate </label>
                - Start from an empty well plate.
            </div>
        </div>
    </div>
    <hr>

    {# sck for raw_plate Extra Info About Plate Maps#}
    <!-- study name {{ object }}  and  id {{ object.id }} -->
    <div class="raw-plate hidden">
        <div class="sample-times hidden">
            <div class="row">
                <div class="col-sm-12">
                    {% include 'generic_field_longer_label.html' with field=form.existing_plate_map_list label="Select Plate Map" %}
                </div>
            </div>
        </div>

        <div class="empty-times hidden">
            <div class="row">
                <div class="col-sm-12" >
                    {% include 'generic_field_longer_label.html' with field=form.well_plate_size label="Select Size" %}
                </div>
            </div>
            <!--what was picked: <input type="text" name="selectedplatesize">-->
        </div>
        <div class="matrix-times hidden">
            <div class="row">
                <div class="col-sm-12">
                    {% include 'generic_field_longer_label.html' with field=form.matrix_list label="Select Matrix" %}
                </div>
            </div>
        </div>
    </div>

    {# sck for raw_plate Table of Chips that are set up#}
    <div class="raw-plate hidden">
        <div class="sample-times empty-times hidden">
        <!-- get the table to actually sort...it doesn't right now-->
            <legend><br>Chips in the Study</legend>
            {% if items %}
            <div class="padded-bottom">
                <table id="matrix_items_table" class="table table-striped table-bordered dataTable " >
                    <thead>
                        <tr role="row">
                            <th>Name</th>
                            <!--<th>MPS Model</th>-->
                            <th>Compound</th>
                            <th>Cell</th>
                            <th>Setting</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in items %}
                            <tr id={{ item.id }} name={{ item.id }}>
                                <td>{{ item.name }}</td>
                                <!--<td>{{ item.organ_model }}</td>-->
                                <td>{{ item.stringify_compounds|linebreaksbr }}</td>
                                <td>{{ item.stringify_cells|linebreaksbr }}</td>
                                <td>{{ item.stringify_settings|linebreaksbr }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            {% else %}
            <div class="alert alert-warning" role="alert">
                No items exist for this study
            </div>
            {% endif %}
        </div>
    </div>

    {# sck for raw_plate The Plate Map#}
    <div class="raw-plate hidden">
    <legend><br>Select Sample, Standard, or Blank and Position on the Plate</legend>
        <div>
            <div class="row">
                <div class="col-sm-4">
                    {% include 'generic_field_longer_label.html' with field=form.plate_map_well_use label="Well Use" %}
                </div>
                 <div class="col-sm-5">

                </div>
                <div class="col-sm-3">
                    {% include 'generic_field_longer_label.html' with field=form.plate_map_time_unit label="Time Unit" %}
                </div>
            </div>
            <div class="row">
                <div class="col-sm-4">
                    {% include 'generic_field_longer_label.html' with field=form.matrix_item_list label="Chip" %}
                </div>
                <div class="col-sm-5">
                    {% include 'generic_field_longer_label.html' with field=form.model_location_list label="Location" %}
                </div>
                <div class="col-sm-3">
                    {% include 'generic_field_longer_label.html' with field=form.sample_time_entry label="Time" %}
                </div>
            </div>
        </div>

        <hr>
        <div class = "row">
            <div class="col-sm-2">
                <p>Show in Plate Map:</p>
            </div>
            <div class="col-sm-10">
                <label><input type="checkbox" id="show_on_plate_map1" checked="checked"> Chip Name </label>
                <label><input type="checkbox" id="show_on_plate_map2" > Sample Location </label>
                <label><input type="checkbox" id="show_on_plate_map3" > Sample Time </label>
            </div>
        </div>
        <hr>

        <div class="row">
            <div class="col-sm-12" >
                <div>


                    <div>
                    <table class="table table-bordered table-inverse" summary="Table selection with plugin" id="tablecellsselection">
                    <!-- table is built in the js file-->
                    </table>
                    </div>

                </div>
            </div>
        </div>


        <div>
            <div class="new-plate-map">
                 <div class="row">
                     <div class="col-sm-2">
                         <!-- function of this button will need to be changed and will need to involve a lot of QC, especially if overwriting  -->
                           <button id="submit" type="submit" class="btn btn-primary">Save Plate Map</button>
                     </div>
                     <div class="col-sm-10" >
                            {% include 'generic_field_longer_label.html' with field=form.well_plate_new_name label="Save with this Name" %}
                     </div>
                     <!--was entered for checking: <input type="text" name="enteredplatename">-->
                </div>
            </div>
            <ul class="list-group">
                <li class="list-group-item">
                    <ul class="list-unstyled">
                        <li>Make and save all the plate maps you will need for a plate reader output file before continuing.
                            <ul class="filled-circle">
                                <li>Incomplete plate maps can be saved (e.g., a plate map without time points), but a plate map must be completed prior to using it for data processing.</li>
                                <li>When using the same well plate at multiple time point, you need a plate map for EACH time point. Recommendation - make a complete map for one time point, then select to start with that plate map, edit the time point, and save it as a new plate map.</li>
                                <li>When using an existing matrix, add sample locations and time points, and standards and blanks (if needed), and save as a plate map.</li>
                                <li>Make sure to save your plate map before navigating to other locations on this page or to other pages or your changes will be lost.</li>
                            </ul>
                        </li>
                    </ul>
                </li>
            </ul>
            <!--<p>Note for development: at this point, all plate maps should be made and saved and the user would be ready to continue with file upload and data processing.</p>-->
        </div>
    </div>

    {% comment %}
    <div class="raw-plate hidden">
        <div >
            <div class="row">
                <div class="col-sm-12" >
                    <i><b><br>Select unit and sample times to be used on this plate </b></i>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-12" >
                    <label><input type="radio" name="sample_time_option" value="one_time_point" checked="checked"> One Sample Time </label>
                    - Samples on assay plate will be from 1 and only one time point.
                </div>
            </div>
            <div class="row">
                <div class="col-sm-12" >
                    <label><input type="radio" name="sample_time_option" value="multiple_time_points"> Mixed Sample Times </label>
                    - Sample on assay plate will be from multiple time points.
                </div>
            </div>
        </div>
    </div>
    {% endcomment %}

    {# sck for raw_plate Table summarizing all previously plate map file processing (including way working on..if submitted)#}
    <div class="raw-plate hidden">
        <legend><br>Review Processing Status of Uploaded Plate Reader Data</legend>
        <li>make a table: Files uploaded, # data grids in file, Handling File Profile, Processing Options selected and saved, Plate Map(s) assigned to file, ....</li>
        <li>Make a checkbox next to each file name, start with NONE checked.</li>
        <br>
    </div>

    <!--all the functions on this page require the uploaded of a file (either previously or now), show always -->
    <legend><br>Select Data File to Upload</legend>
    <div class="raw-plate hidden">
        <p>To work with a file uploaded previously, check the box next to the file in the Status table and skip this step.</p>
        <br>
    </div>

    <!--could put this in a mif-c class div?-->
    {% if form.errors %}
        {% for error in form.bulk_file.errors %}
            <div class="alert alert-danger" role="alert">
                <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                <span class="sr-only">Error:</span>
                {{ error }}
            </div>
        {% endfor %}
        {% for error in form.non_field_errors %}
            <div class="alert alert-danger" role="alert">
                <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                <span class="sr-only">Error:</span>
                {{ error }}
            </div>
        {% endfor %}
    <div class="form-group has-error">
    {% else %}
    <div class="form-group">
    {% endif %}
        <label for="bulk_file" class="col-sm-2 control-label">File*</label>
        <div class="col-sm-10">
            {{ form.bulk_file }}
        </div>
    </div>

    <div class="raw-plate hidden">
        <p>Select the assay and, if not processing the data, the unit of the value in the file, or, if calibrating to a standard, the unit of the standard.</p>
        <br>
        <div>
            <div class="row">
                <div class="col-sm-6">
                    {% include 'generic_field_longer_label.html' with field=form.assay_list label="Assay" %}
                </div>
                <div class="col-sm-6">
                    {% include 'generic_field_longer_label.html' with field=form.assay_unit_list label="Unit" %}
                </div>
            </div>
        </div>
    </div>

    {# sck for raw_plate Picking the processing options#}
    <div class="raw-plate hidden">
        <legend><br>Plate Reader Data Processing Options</legend>
        <li>If more than one grid, how handle it?</li>
    </div>

    {# sck for raw_plate Calibrating data#}
    <div class="raw-plate hidden">
        <legend><br>Process Plate Reader Data (Calibrate)</legend>
    </div>

    {# sck for raw_plate Annotation (require dilition and cells to be entered in a table...#}
    <div class="raw-plate hidden">
        <legend><br>Annotate Plate Reader Data</legend>

        <br>
    </div>

    {# supporting_data section #}
    <div class="supporting-data hidden">
        {# NOT DRY #}
        {{ supporting_data_formset.management_form }}
        <legend><br>Supporting Data</legend>
        {% if supporting_data_formset.non_form_errors %}
            <div class="alert alert-danger" role="alert">
                <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                <span class="sr-only">Error:</span>
                {{ supporting_data_formset.non_form_errors }}
            </div>
        {% endif %}

        {% if supporting_data_formset.errors %}
            {% for dict in supporting_data_formset.errors %}
                {% for key,value in dict.items %}
                    {% if key %}
                        <div class="alert alert-danger" role="alert">
                            <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                            <span class="sr-only">Error:</span>
                            {{ forloop.parentloop.counter }}.) {{ key }} : {{ value }}
                        </div>
                    {% endif %}
                {% endfor %}
            {% endfor %}
        {% endif %}

        <a id="add_button-{{ supporting_data_formset.prefix }}" class="btn btn-success" role="button">Add Supporting Data</a>
        <table class="table table-striped inlines" id="{{ supporting_data_formset.prefix }}-group" name="supporting_data">
            <thead>
                <tr>
                    <th>Description*</th>
                    <th>Supporting Data File*</th>
                    <th>Delete</th>
                </tr>
            </thead>
            <tbody>
                {% for supporting_data in supporting_data_formset %}
                    <tr class="inline" id="supporting_data-{{ forloop.counter0 }}">
                        {% if supporting_data.id.value %}
                        <td class="original" hidden>
                            <input type="hidden"
                                   id="id_{{ supporting_data_formset.prefix }}-{{ forloop.counter0 }}-id"
                                   name="{{ supporting_data_formset.prefix }}-{{ forloop.counter0 }}-id"
                                   value="{{ supporting_data.id.value }}">
                        </td>
                        {% endif %}
                        <td>{{ supporting_data.description }}</td>
                        <td>{{ supporting_data.supporting_data }}</td>
                        <td>{{ supporting_data.DELETE }}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {# raw_plate and mif-c#}
    <div class="raw-plate mif-c">
        {# Excluded for now #}
    {#    <div hidden>#}
    {#    {% include 'generic_field_longer_label.html' with field=form.overwrite_option label="Overwrite Option*" %}#}
    {#    </div>#}

        <br>
        <div class="mif-c">
            <p>
                <a href="/media/excel_templates/chip_template-{{ version }}.xlsx">Click Here For Upload Template</a>
            </p>
        </div>
        <br>

        {% include 'assays/assaydatafileupload_table.html' with show_delete="true" group=object.group.name %}

        {# Temporary #}
        {# {% include 'assays/chart_options.html' with chart_title="New Data" chart_prefix="charts" %} #}
        {% include 'assays/sidebar_extras.html' with show_hide="true" %}

        <legend><br>Plots of Data Marked for Removal from the Study</legend>
        <!--This is something that has been discussed for all types of data-->
        <!--Bert had suggested that this be shown with the data that are added-->
        <!--the idea is to replace the auto marking of replaced values -->

        <legend><br>Plots of Data to Be Added to the Study</legend>
        <!--Plots of the data in the MIF-C file or that has been processed and is ready for submission to the main study-->

        <div id="charts" class="padded-bottom">Preview Unavailable</div>

        {# Revised for now #}
        {# {% include 'assays/chart_options.html' with chart_title="New Data" chart_prefix="new_charts" %} #}
        {# <div id="new_charts" class="padded-bottom">Preview Unavailable</div> #}

        {# {% include 'assays/chart_options.html' with chart_title="Current Data" chart_prefix="current_charts" %} #}
        {# <div id="current_charts" class="padded-bottom">No Current Data</div> #}

        {% include 'assays/group_table.html' %}
    </div>

    </form>
{% endblock %}
